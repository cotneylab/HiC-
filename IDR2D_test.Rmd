---
title: "IDR2R for HiC and 4C data on UCHC HPC"
knit: (function(IDR2D_test, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(IDR2D_test,
 encoding=encoding,
 output_file=file.path("/Users/awilderman/Documents/GitHub/Scratchpads/HiC-/", out_dir, 'index.html'))})
output: 
  html_document:
    keep_md: true
---

## Please note

The scripts included in this document are formatted for use with a slurm scheduler, where applicable

The citation for the package being used is:
IDR2D identifies reproducible genomic interactions
Konstantin Krismer, Yuchun Guo, and David K. Gifford
Nucleic Acids Research, Volume 48, Issue 6, 06 April 2020, Page e31; DOI: https://doi.org/10.1093/nar/gkaa030

R 3.6 (or higher) and Bioconductor 3.10 is required.

## create the R script that will parse HiC data generated by HiC-Pro

```{bash make}
export MATRIXDIR=~/ANALYSIS/HiC/CNCC/hic_results/matrix
export SAMPLE=WT
export REP1=AWIL064
export REP2=AWIL065
export RES=1000000
export RES_NICK=1Mb

echo "#! /isg/shared/apps/R/3.6.0/Rscript --vanilla --no-save
library(idr2d)
library(ggplot2)

setwd(\"/home/FCAM/awilderman/ANALYSIS/HiC/WT_INV_CNCC/IDR2D\")" > IDR2Dbychrom.R

for CHR in chr1 chr2 chr3 chr4 chr5 chr6 chr7 chr8 chr9 chr10 chr11 chr12 chr13 chr14 chr15 chr16 chr17 chr18 chr19 chr20 chr21 chr22 chrX

do 
	echo $REP1"_df_"$CHR" <- parse_hic_pro_matrix(\""$MATRIXDIR"/"$REP1"/iced/"$RES"/"$REP1"_"$RES"_iced.matrix\", \""$MATRIXDIR"/"$REP1"/raw/"$RES"/"$REP1"_"$RES"_abs.bed\", chromosome = \""$CHR"\") 
	"$REP2"_df_"$CHR" <- parse_hic_pro_matrix(\""$MATRIXDIR"/"$REP2"/iced/"$RES"/"$REP2"_"$RES"_iced.matrix\", \""$MATRIXDIR"/"$REP2"/raw/"$RES"/"$REP2"_"$RES"_abs.bed\", chromosome = \""$CHR"\")

	idr_results_"$SAMPLE"_df_"$CHR" <- estimate_idr2d_hic("$REP1"_df_"$CHR", "$REP2"_df_"$CHR", max_factor = 1.5, jitter_factor = 1e-04, mu = 0.1, sigma = 1, rho = 0.2, p = 0.5, eps = 0.001, max_iteration = 30, local_idr = TRUE)

	summary(idr_results_"$SAMPLE"_df_"$CHR")

	pdf(\"idr_"$SAMPLE"_distribution_histogram_"$RES_NICK"_"$CHR".pdf\")
	draw_idr_distribution_histogram(idr_results_"$SAMPLE"_df_"$CHR")
	dev.off()

	pdf(\"idr_"$SAMPLE"_rank_scatterplot_"$RES_NICK"_"$CHR".pdf\")
	draw_rank_idr_scatterplot(idr_results_"$SAMPLE"_df_"$CHR")
	dev.off()

	pdf(\"idr_"$SAMPLE"_value_scatterplot_"$RES_NICK"_"$CHR".pdf\")
	draw_value_idr_scatterplot(idr_results_"$SAMPLE"_df_"$CHR")
	dev.off()

	pdf(\""$SAMPLE"_hic_contact_map_"$RES_NICK"_"$CHR"_w_cutoff.pdf\")
	draw_hic_contact_map(idr_results_"$SAMPLE"_df_"$CHR", idr_cutoff = 0.05, chromosome = \""$CHR"\")
	dev.off()

	pdf(\""$SAMPLE"_hic_contact_map_"$RES_NICK"_"$CHR"_no_cutoff.pdf\")
	draw_hic_contact_map(idr_results_"$SAMPLE"_df_"$CHR", chromosome = \""$CHR"\")
	dev.off()" >> IDR2Dbychrom.R
done

```
## Create slurm script to launch

````
#!/bin/bash  
#SBATCH -N 1 
#SBATCH -n 1 
#SBATCH -t 100:00:00 
#SBATCH --mem-per-cpu=8G 
#SBATCH -p general 
#SBATCH	--qos=general 
#SBATCH --mail-user= 
#SBATCH --mail-type=end 
#SBATCH --job-name=IDR2Dbychrom 

module load R/3.6.0 
cd ~/ANALYSIS/HiC/WT_INV_CNCC/IDR2D 
Rscript --no-save --no-restore --verbose IDR2Dbychrom.R > IDR2Dbychrom.Rout 2>&1

```{r histogram, fig.cap='Histogram - Chr22', echo=FALSE}
knitr::include_graphics("/Users/awilderman/Documents/GitHub/Scratchpads/HiC-/images/idr_WT_distribution_histogram_1Mb_chr22.pdf")
```

```{r scatterplot, fig.cap='Scatterplot - Chr22', echo=FALSE}
knitr::include_graphics("/Users/awilderman/Documents/GitHub/Scratchpads/HiC-/images/idr_WT_rank_scatterplot_1Mb_chr22.pdf")
```
